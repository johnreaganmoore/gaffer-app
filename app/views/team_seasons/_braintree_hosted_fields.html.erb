<div class="season-checkout-container container">
  <%= form_tag transactions_path, id: "checkout-form" do %>
    <div id="error-message"></div>


    <div class="card">
      <div class="card-content">

        <% unless person.id %>
          <p>Please enter your billing info:</p>

          <div class="row">
            <div class="input-field col s12 m6 l6">
              <%= text_field_tag :first_name %>
              <%= label_tag :first_name %>
            </div>

            <div class="input-field col s12 m6 l6">
              <%= text_field_tag :last_name %>
              <%= label_tag :last_name %>
            </div>
          </div>
          <div class="row">
            <div class="input-field col s12">
              <%= email_field_tag :email %>
              <%= label_tag :email %>
            </div>
          </div>
        <% end %>



        <div class="row">
          <div class="textfield--float-label col s12">
            <label class="hosted-field--label" for="card-number">
              Card Number
            </label>
            <div id="card-number" class="hosted-field"></div>
          </div>
        </div>

        <div class="row">
          <div class="textfield--float-label col s12 m6 l6">
            <label class="hosted-field--label" for="expiration-date">
              Expiration Date</label>
            <div id="expiration-date" class="hosted-field"></div>
          </div>

          <div class="textfield--float-label col s12 m6 l6">
            <label class="hosted-field--label" for="cvv">
                CVV</label>
            <div id="cvv" class="hosted-field"></div>
          </div>
        </div>

        <p class="agreement-line">
          By paying for your participation in this season you agree to our <%= link_to 'terms of service and privacy policy', tos_path, target: '_blank' %>.
        </p>

      </div>
      <div class="card-action edit-profile-actions">
        <input class="waves-effect waves-light btn white blue-grey-text" type="submit" value="Pay <%= number_to_currency(team_season.new_player_cost +  (team_season.new_player_cost * 0.1).round) %>" disabled>
      </div>
    </div>


    <input type="hidden" name="season" value="<%= team_season.id %>">
    <input type="hidden" name="person" value="<%= person.id %>">
    <input type="hidden" name="payment-method-nonce">
  <% end %>

  <script src="https://js.braintreegateway.com/web/3.5.0/js/client.min.js"></script>

  <script src="https://js.braintreegateway.com/web/3.5.0/js/hosted-fields.min.js"></script>

  <script>
  // We generated a client token for you so you can test out this code
  // immediately. In a production-ready integration, you will need to
  // generate a client token on your server (see section below).
  // var authorization = 'eyJ2ZXJzaW9uIjoyLCJhdXRob3JpemF0aW9uRmluZ2VycHJpbnQiOiIwYWM2ZmE5ZDI2OTg3ODQ3M2ZlZWI2OTFlN2I4MzIwNDg5ZGVjOGY3MGE1NmMxZjBkY2I1ZWI2MTc3ZWI5OTE3fGNyZWF0ZWRfYXQ9MjAxNi0wOS0yOVQwMTo1Mjo1NS43NjgyMjg1NDYrMDAwMFx1MDAyNm1lcmNoYW50X2lkPTM0OHBrOWNnZjNiZ3l3MmJcdTAwMjZwdWJsaWNfa2V5PTJuMjQ3ZHY4OWJxOXZtcHIiLCJjb25maWdVcmwiOiJodHRwczovL2FwaS5zYW5kYm94LmJyYWludHJlZWdhdGV3YXkuY29tOjQ0My9tZXJjaGFudHMvMzQ4cGs5Y2dmM2JneXcyYi9jbGllbnRfYXBpL3YxL2NvbmZpZ3VyYXRpb24iLCJjaGFsbGVuZ2VzIjpbXSwiZW52aXJvbm1lbnQiOiJzYW5kYm94IiwiY2xpZW50QXBpVXJsIjoiaHR0cHM6Ly9hcGkuc2FuZGJveC5icmFpbnRyZWVnYXRld2F5LmNvbTo0NDMvbWVyY2hhbnRzLzM0OHBrOWNnZjNiZ3l3MmIvY2xpZW50X2FwaSIsImFzc2V0c1VybCI6Imh0dHBzOi8vYXNzZXRzLmJyYWludHJlZWdhdGV3YXkuY29tIiwiYXV0aFVybCI6Imh0dHBzOi8vYXV0aC52ZW5tby5zYW5kYm94LmJyYWludHJlZWdhdGV3YXkuY29tIiwiYW5hbHl0aWNzIjp7InVybCI6Imh0dHBzOi8vY2xpZW50LWFuYWx5dGljcy5zYW5kYm94LmJyYWludHJlZWdhdGV3YXkuY29tLzM0OHBrOWNnZjNiZ3l3MmIifSwidGhyZWVEU2VjdXJlRW5hYmxlZCI6dHJ1ZSwicGF5cGFsRW5hYmxlZCI6dHJ1ZSwicGF5cGFsIjp7ImRpc3BsYXlOYW1lIjoiQWNtZSBXaWRnZXRzLCBMdGQuIChTYW5kYm94KSIsImNsaWVudElkIjpudWxsLCJwcml2YWN5VXJsIjoiaHR0cDovL2V4YW1wbGUuY29tL3BwIiwidXNlckFncmVlbWVudFVybCI6Imh0dHA6Ly9leGFtcGxlLmNvbS90b3MiLCJiYXNlVXJsIjoiaHR0cHM6Ly9hc3NldHMuYnJhaW50cmVlZ2F0ZXdheS5jb20iLCJhc3NldHNVcmwiOiJodHRwczovL2NoZWNrb3V0LnBheXBhbC5jb20iLCJkaXJlY3RCYXNlVXJsIjpudWxsLCJhbGxvd0h0dHAiOnRydWUsImVudmlyb25tZW50Tm9OZXR3b3JrIjp0cnVlLCJlbnZpcm9ubWVudCI6Im9mZmxpbmUiLCJ1bnZldHRlZE1lcmNoYW50IjpmYWxzZSwiYnJhaW50cmVlQ2xpZW50SWQiOiJtYXN0ZXJjbGllbnQzIiwiYmlsbGluZ0FncmVlbWVudHNFbmFibGVkIjp0cnVlLCJtZXJjaGFudEFjY291bnRJZCI6ImFjbWV3aWRnZXRzbHRkc2FuZGJveCIsImN1cnJlbmN5SXNvQ29kZSI6IlVTRCJ9LCJjb2luYmFzZUVuYWJsZWQiOmZhbHNlLCJtZXJjaGFudElkIjoiMzQ4cGs5Y2dmM2JneXcyYiIsInZlbm1vIjoib2ZmIn0=';
  var form = document.querySelector('#checkout-form');
  var submit = document.querySelector('input[type="submit"]');

  braintree.client.create({
    authorization: '<%= client_token %>'
  }, function (clientErr, clientInstance) {
    if (clientErr) {
      // Handle error in client creation
      return;
    }

    braintree.hostedFields.create({
      client: clientInstance,
      styles: {
        'input': {
          'font-size': '1rem',
          'font-family': 'exo 2, lato, helvetica, sans-serif'
        },
        'input.focused': {
          'color': 'black'
        },
        'input.invalid': {
          'color': 'tomato'
        },
        'input.valid': {
          'color': '#6FA135'
        }
      },
      fields: {
        number: {
          selector: '#card-number',
          placeholder: '4111 1111 1111 1111'
        },
        cvv: {
          selector: '#cvv',
          placeholder: '123'
        },
        expirationDate: {
          selector: '#expiration-date',
          placeholder: '10 / 2019'
        }
      }
    }, function (hostedFieldsErr, hostedFieldsInstance) {
      if (hostedFieldsErr) {
        // Handle error in Hosted Fields creation
        return;
      }

      submit.removeAttribute('disabled');

      form.addEventListener('submit', function (event) {
        event.preventDefault();

        hostedFieldsInstance.tokenize(function (tokenizeErr, payload) {

          if (tokenizeErr) {
            // Handle error in Hosted Fields tokenization
            return;
          }

          // Put `payload.nonce` into the `payment-method-nonce` input, and then
          // submit the form. Alternatively, you could send the nonce to your server
          // with AJAX.

          document.querySelector('input[name="payment-method-nonce"]').value = payload.nonce;
          form.submit();
        });
      }, false);

    });
  });
  </script>
</div>
